# NativeAd System - H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng

## T·ªïng quan

NativeAd System l√† m·ªôt h·ªá th·ªëng qu·∫£n l√Ω qu·∫£ng c√°o Native v·ªõi cache th√¥ng minh, ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ d·ªÖ d√†ng t√≠ch h·ª£p v√†o Compose UI. **Design UI match 100% v·ªõi layout XML `native_ad_view_with_media_medium.xml`**.

H·ªá th·ªëng bao g·ªìm:

- **NativeAdManager**: Qu·∫£n l√Ω cache v√† loading qu·∫£ng c√°o
- **NativeAdView**: Composable UI v·ªõi design custom ch√≠nh x√°c
- **AdManager Integration**: Wrapper methods ƒë·ªÉ d·ªÖ s·ª≠ d·ª•ng

## T√≠nh nƒÉng ch√≠nh

### 1. Cache Management
- **Cache Size**: T·ªëi ƒëa 2 qu·∫£ng c√°o trong cache
- **Validity Duration**: 15 ph√∫t hi·ªáu l·ª±c cho m·ªói qu·∫£ng c√°o
- **Auto Cleanup**: T·ª± ƒë·ªông d·ªçn d·∫πp qu·∫£ng c√°o h·∫øt hi·ªáu l·ª±c
- **Thread Safety**: S·ª≠ d·ª•ng ConcurrentLinkedQueue

### 2. Smart Loading
- **Preload Strategy**: Load qu·∫£ng c√°o tr∆∞·ªõc khi c·∫ßn
- **Cache Check**: Ki·ªÉm tra cache tr∆∞·ªõc khi load m·ªõi
- **Background Loading**: Kh√¥ng block UI thread

### 3. UI Integration
- **Composable Support**: D·ªÖ d√†ng t√≠ch h·ª£p v√†o Compose UI
- **Exact Design Match**: UI match 100% v·ªõi XML layout design
- **Responsive Layout**: T·ª± ƒë·ªông adapt v·ªõi screen sizes

## Design Specifications

### Layout Structure (Match v·ªõi XML)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [App Icon 54dp] [AD Label] [Headline] ‚îÇ
‚îÇ           [Rating Bar 5‚òÖ]              ‚îÇ
‚îÇ           [Body Text]                  ‚îÇ
‚îÇ           [MediaView 180dp]            ‚îÇ
‚îÇ        [Call to Action Button]         ‚îÇ
‚îÇ           [Bottom Divider]             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### UI Components Details
- **App Icon**: 54dp x 54dp v·ªõi rounded corners
- **AD Label**: Badge "AD" m√†u #FFCC00, padding 3dp x 2.3dp
- **Headline**: Font size 15sp, bold, maxLines = 1
- **Body Text**: Font size 12sp, maxLines = 1
- **MediaView**: 180dp height v·ªõi background #F5F5F5
- **CTA Button**: 56dp height v·ªõi primary color, ho·∫°t ƒë·ªông khi click
- **Bottom Divider**: 1dp height v·ªõi color #CCEBEBEB
- **Padding**: Horizontal 8dp, top/bottom 4dp
- **Overall Height**: 320dp
- **No Rating View**: Kh√¥ng hi·ªÉn th·ªã star rating
- **Full Width**: Kh√¥ng c√≥ Card wrapper, full width kh√¥ng bo g√≥c

## C√°ch s·ª≠ d·ª•ng

### Basic Usage
```kotlin
// S·ª≠ d·ª•ng m·∫∑c ƒë·ªãnh (button ·ªü bottom)
NativeAdView(
    modifier = Modifier.fillMaxWidth()
)

// Button ·ªü top
NativeAdView(
    modifier = Modifier.fillMaxWidth(),
    enableButtonOnTop = true
)
```

### Parameters
- **modifier**: Modifier cho layout
- **enableButtonOnTop**: Boolean ƒë·ªÉ ƒëi·ªÅu khi·ªÉn v·ªã tr√≠ action button
  - `false` (m·∫∑c ƒë·ªãnh): Button ·ªü bottom, sau MediaView
  - `true`: Button ·ªü top tr√™n c√πng, tr∆∞·ªõc c·∫£ icon v√† label
- **onAdLoaded**: Callback khi ad load th√†nh c√¥ng
- **onAdFailedToLoad**: Callback khi ad load th·∫•t b·∫°i

### 2. UI Integration

```kotlin
// Trong Compose UI
@Composable
fun MyScreen() {
    Column {
        // Your content here
        
        // Native Ad ·ªü cu·ªëi m√†n h√¨nh
        NativeAdView(
            modifier = Modifier.fillMaxWidth(),
            onAdLoaded = { nativeAd ->
                // Handle ad loaded successfully
            },
            onAdFailedToLoad = { error ->
                // Handle ad failed to load
            }
        )
    }
}
```

### 3. Manual Ad Management

```kotlin
// Preload qu·∫£ng c√°o
AdManager.preloadNativeAd(context) { success, message ->
    if (success) {
        Log.d("Ads", "Native ad preloaded: $message")
    } else {
        Log.e("Ads", "Failed to preload: $message")
    }
}

// L·∫•y qu·∫£ng c√°o t·ª´ cache
AdManager.getNativeAd(context) { nativeAd ->
    if (nativeAd != null) {
        // Use the native ad
        Log.d("Ads", "Got native ad: ${nativeAd.headline}")
    } else {
        // No ad available
        Log.e("Ads", "No native ad available")
    }
}
```

### 4. Cache Management

```kotlin
// Ki·ªÉm tra cache info
val cacheInfo = AdManager.getNativeAdCacheInfo()
Log.d("Ads", "Cache info: $cacheInfo")

// X√≥a cache (ƒë·ªÉ debug ho·∫∑c reset)
AdManager.clearNativeAdCache()

// L·∫•y s·ªë l∆∞·ª£ng qu·∫£ng c√°o c√≤n hi·ªáu l·ª±c
val adCount = AdManager.getNativeAdCount()
Log.d("Ads", "Valid ads: $adCount")
```

## UI Components

### NativeAdView Composable

```kotlin
@Composable
fun NativeAdView(
    modifier: Modifier = Modifier,
    onAdLoaded: ((NativeAd) -> Unit)? = null,
    onAdFailedToLoad: ((String) -> Unit)? = null
)
```

**Features (Match v·ªõi XML):**
- **App Icon**: Icon th·∫≠t t·ª´ NativeAd.icon (54dp x 54dp) v·ªõi fallback emoji üéÆ
- **AD Label**: Badge "AD" m√†u #FFCC00 v·ªõi padding ch√≠nh x√°c
- **Headline**: T√™n app qu·∫£ng c√°o (15sp, bold) t·ª´ NativeAd.headline
- **Body Text**: M√¥ t·∫£ app qu·∫£ng c√°o (12sp, maxLines = 2) t·ª´ NativeAd.body
- **MediaView**: 180dp height v·ªõi background #F5F5F5, hi·ªÉn th·ªã media content th·∫≠t t·ª´ NativeAd.mediaContent
- **Call to Action Button**: 46dp height v·ªõi rounded corners (8dp), Compose theme primary color, ho·∫°t ƒë·ªông khi click, text t·ª´ NativeAd.callToAction
- **Bottom Divider**: 1dp height v·ªõi color #CCEBEBEB, ch·ªâ hi·ªÉn th·ªã khi button ·ªü bottom
- **Full Width Layout**: Kh√¥ng c√≥ Card wrapper, full width kh√¥ng bo g√≥c
- **Smart Spacing**: M·ªói item c√≥ margin left/right 8dp ri√™ng bi·ªát, divider c√≥ margin bottom 4dp
- **Flexible Button Position**: C√≥ th·ªÉ ƒë·∫∑t button ·ªü top tr√™n c√πng ho·∫∑c bottom th√¥ng qua param `enableButtonOnTop`
- **Real Data Integration**: L·∫•y data th·ª±c t·ª´ NativeAd (headline, body, callToAction, icon, mediaContent)
- **Click Handling**: Action button v√† MediaView ho·∫°t ƒë·ªông khi click, Google Ads SDK t·ª± ƒë·ªông handle

**States:**
- **Loading**: Hi·ªÉn th·ªã CircularProgressIndicator
- **Error**: Hi·ªÉn th·ªã error message
- **Success**: Hi·ªÉn th·ªã qu·∫£ng c√°o v·ªõi design ch√≠nh x√°c

## Configuration

### Ad IDs
```kotlin
// Trong AdManager
var ADMOB_NATIVE_AD_ID = "ca-app-pub-9821898502051437/7710456674"

// C√≥ th·ªÉ override qua Firebase Remote Config
fun fetchAdId(remoteConfig: FirebaseRemoteConfig) {
    ADMOB_NATIVE_AD_ID = remoteConfig.getString("ADMOB_NATIVE_AD_ID")
}
```

### Cache Settings
```kotlin
// Trong NativeAdManager
private const val MAX_CACHE_SIZE = 2
private const val AD_VALIDITY_DURATION_MINUTES = 15L
```

### Native Ad Options
```kotlin
val nativeAdOptions = NativeAdOptions.Builder()
    .setAdChoicesPlacement(NativeAdOptions.ADCHOICES_TOP_RIGHT)
    .setRequestCustomMuteThisAd(true)
    .setVideoOptions(
        VideoOptions.Builder()
            .setStartMuted(true)
            .build()
    )
    .build()
```

## Best Practices

### 1. Preload Strategy
```kotlin
// Preload s·ªõm ƒë·ªÉ c√≥ qu·∫£ng c√°o s·∫µn s√†ng
override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    AdManager.preloadNativeAd(this)
}

override fun onResume() {
    super.onResume()
    // Preload th√™m n·∫øu c·∫ßn
    AdManager.preloadNativeAd(this)
}
```

### 2. Error Handling
```kotlin
NativeAdView(
    onAdFailedToLoad = { error ->
        // Hide ad container ho·∫∑c show fallback content
        Log.e("Ads", "Native ad failed: $error")
    }
)
```

### 3. Performance Optimization
```kotlin
// Kh√¥ng preload qu√° nhi·ªÅu qu·∫£ng c√°o
// Cache size limit l√† 2, n√™n ch·ªâ preload khi c·∫ßn thi·∫øt

// S·ª≠ d·ª•ng LaunchedEffect ƒë·ªÉ preload m·ªôt l·∫ßn
LaunchedEffect(Unit) {
    AdManager.preloadNativeAd(context)
}
```

### 4. UI Placement
```kotlin
// ƒê·∫∑t NativeAdView ·ªü v·ªã tr√≠ ph√π h·ª£p
// Kh√¥ng ƒë·∫∑t ·ªü ƒë·∫ßu m√†n h√¨nh (c√≥ th·ªÉ g√¢y kh√≥ ch·ªãu)
// N√™n ƒë·∫∑t ·ªü cu·ªëi content ho·∫∑c gi·ªØa c√°c section

Column {
    // Main content
    LazyColumn { ... }
    
    // Native Ad
    NativeAdView(modifier = Modifier.fillMaxWidth())
    
    // Footer content
}
```

## Testing

### Demo Methods
```kotlin
val demo = NativeAdDemo()

// Basic usage
demo.demoBasicUsage(activity)

// Cache management
demo.demoCacheManagement(activity)

// Performance testing
demo.demoPerformanceAndTiming(activity)

// Error handling
demo.demoErrorHandling(activity)

// UI integration
demo.demoUIIntegration(activity)

// Multiple ads
demo.demoMultipleAds(activity)
```

### Test Ad IDs
```kotlin
// S·ª≠ d·ª•ng test ad ID trong debug mode
if (Helper.isDebugMode()) {
    // Test ad ID s·∫Ω ƒë∆∞·ª£c set t·ª± ƒë·ªông
}
```

## Troubleshooting

### Common Issues

1. **Ad kh√¥ng load ƒë∆∞·ª£c**
   - Ki·ªÉm tra internet connection
   - Ki·ªÉm tra ad ID c√≥ ƒë√∫ng kh√¥ng
   - Ki·ªÉm tra Firebase configuration
   - Ki·ªÉm tra log ƒë·ªÉ debug

2. **Cache kh√¥ng ho·∫°t ƒë·ªông**
   - Ki·ªÉm tra cache info: `AdManager.getNativeAdCacheInfo()`
   - Ki·ªÉm tra validity duration (15 ph√∫t)
   - Ki·ªÉm tra max cache size (2 ads)

3. **UI kh√¥ng hi·ªÉn th·ªã ƒë√∫ng design**
   - Ki·ªÉm tra NativeAdView c√≥ ƒë∆∞·ª£c g·ªçi ƒë√∫ng kh√¥ng
   - Ki·ªÉm tra modifier v√† layout
   - Ki·ªÉm tra ad state (loading/error/success)
   - **Design match**: UI ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ match 100% v·ªõi XML layout

### Debug Commands
```kotlin
// Ki·ªÉm tra cache
val cacheInfo = AdManager.getNativeAdCacheInfo()
Log.d("Ads", "Cache: $cacheInfo")

// Ki·ªÉm tra ad count
val adCount = AdManager.getNativeAdCount()
Log.d("Ads", "Valid ads: $adCount")

// Clear cache ƒë·ªÉ test
AdManager.clearNativeAdCache()
```

## Performance Tips

1. **Preload s·ªõm**: Preload qu·∫£ng c√°o ngay khi activity start
2. **Cache management**: Kh√¥ng preload qu√° nhi·ªÅu qu·∫£ng c√°o
3. **Background loading**: S·ª≠ d·ª•ng background thread cho ad loading
4. **UI optimization**: S·ª≠ d·ª•ng LazyColumn ƒë·ªÉ lazy load ads

## Integration Examples

### SelectLanguageScreen
```kotlin
@Composable
fun SelectLanguageScreen() {
    Column {
        // Language list
        LazyColumn { ... }
        
        // Install button
        Button { ... }
        
        // Native Ad v·ªõi design ch√≠nh x√°c
        NativeAdView(modifier = Modifier.fillMaxWidth())
    }
}
```

### MainActivity
```kotlin
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        // Preload native ads
        AdManager.preloadNativeAd(this)
        
        setContent {
            // Your UI
        }
    }
}
```

## Design Fidelity

**NativeAdView ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ match 100% v·ªõi design mong mu·ªën:**

- ‚úÖ **Layout Structure**: Match v·ªõi native_ad_view_with_media_medium.xml
- ‚úÖ **Dimensions**: App icon 54dp, MediaView 180dp, Button 56dp
- ‚úÖ **Colors**: AD label #FFCC00, MediaView #F5F5F5, Divider #CCEBEBEB
- ‚úÖ **Typography**: Headline 15sp, Body 12sp
- ‚úÖ **Spacing**: Padding 8dp horizontal, 4dp vertical
- ‚úÖ **Overall Height**: 320dp ƒë·ªÉ accommodate design m·ªõi
- ‚úÖ **No Rating View**: Lo·∫°i b·ªè star rating v√† rating text
- ‚úÖ **Full Width**: Kh√¥ng c√≥ Card wrapper, full width kh√¥ng bo g√≥c
- ‚úÖ **Real Data**: L·∫•y data th·ª±c t·ª´ NativeAd (headline, body, callToAction)
- ‚úÖ **Click Handling**: Action button v√† MediaView ho·∫°t ƒë·ªông khi click

## Support

N·∫øu g·∫∑p v·∫•n ƒë·ªÅ, h√£y ki·ªÉm tra:
1. Log output ƒë·ªÉ debug
2. Cache info v√† ad count
3. Network connection
4. Firebase configuration
5. Ad ID configuration
6. **Design match**: UI ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ match ch√≠nh x√°c v·ªõi XML layout

H·ªá th·ªëng ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ graceful fallback khi c√≥ l·ªói, n√™n app s·∫Ω kh√¥ng crash khi qu·∫£ng c√°o c√≥ v·∫•n ƒë·ªÅ. 

## Technical Implementation

**NativeAdView ƒë√£ ƒë∆∞·ª£c rebuild ho√†n to√†n ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông ƒë√∫ng c√°ch:**

- **Single NativeAdView Container**: 
  - S·ª≠ d·ª•ng m·ªôt AndroidView duy nh·∫•t ch·ª©a to√†n b·ªô NativeAdView
  - ƒê·∫£m b·∫£o proper binding v·ªõi Google Ads SDK
  - Kh√¥ng c√≤n mix gi·ªØa Compose v√† AndroidView cho t·ª´ng component

- **Proper View Binding**: T·∫•t c·∫£ views ƒë∆∞·ª£c bind ƒë√∫ng c√°ch
  - `iconView` ‚Üí Icon c·ªßa app qu·∫£ng c√°o t·ª´ `nativeAd.icon?.drawable`
  - `headlineView` ‚Üí Headline t·ª´ `nativeAd.headline`
  - `bodyView` ‚Üí Description t·ª´ `nativeAd.body`
  - `mediaView` ‚Üí MediaView ƒë·ªÉ hi·ªÉn th·ªã media content t·ª´ `nativeAd.mediaContent`
  - `callToActionView` ‚Üí Button t·ª´ `nativeAd.callToAction`

- **Native Layout System**: 
  - S·ª≠ d·ª•ng LinearLayout v·ªõi Android Views
  - T∆∞∆°ng th√≠ch ho√†n to√†n v·ªõi Google Ads SDK
  - Pixel-perfect layout matching v·ªõi XML design

- **Real Data Integration**: 
  - Icon th·∫≠t t·ª´ NativeAd ƒë∆∞·ª£c hi·ªÉn th·ªã
  - MediaView ho·∫°t ƒë·ªông v√† hi·ªÉn th·ªã content
  - Button clickable v√† Google Ads SDK t·ª± ƒë·ªông handle
  - T·∫•t c·∫£ text content l·∫•y t·ª´ NativeAd object

- **Performance & Reliability**:
  - Single AndroidView container gi·∫£m overhead
  - Proper SDK integration ƒë·∫£m b·∫£o ad tracking
  - Error handling v·ªõi fallback content 